---
title: 基于腾讯云开发的简单用户系统
date: 2020-03-31 22:20:45
tags:
     - BaaS
     - 系统设计
     - 云开发
categories: 代码人生
---

在这个一切上云的时代，BaaS对客户端工程师实在是过于友好。能够低成本建立一个完整的产品，不用忙碌于后端运维。加上全自动的负载均衡和灾备扩容，让人能省下大把的精力时间来专注于业务。

然而，即使成本再小，服务端的开发也是必备的。就算数据库完全不用管，总得写监控一下每日的关键流量吧？对开发人员特别友好的，有Bmob和LeanCloud之类，集成了很多实用的功能，非常方便。而自定义程度更高，相对更需要底层设计的阿里云，腾讯云之类，就容易满足一些复杂的场景。

出于成本和效率上的原因，经过重重考证后，我在一个新项目上完全迁移到了腾讯云。此次简单用户系统的搭建，是对其云开发产品的具体实践。

<!--more-->

## 何为云开发

简单的说：就是把数据库、云函数、云储存和静态网页托管集成到一个环境中。每个项目绑定一个独立环境。

以前我用的最多的是阿里云 + Bmob 组合，因为前者的数据库太贵，后者的云函数太贵🤣云开发除了价格低廉外，最大的特色是对 Flutter 的高度支持。相比于 Bmob 还需要自行处理序列化的SDK，云开发的调用更加简单直接，而且其独立的ticket用户鉴权方案，也很方便与自有的用户系统对接。

着重要说的一点是，其文档型数据库支持以集合（表）为单位进行权限控制，安全规则使用json格式和表达式配置，非常简单直观。配合上动态ticket的客户端鉴权模式，应该说安全性是非常好的。而且云函数对数据库的操作不受规则影响，灵活程度也很高。

## 简单用户系统

云开发自带的用户管理只是个负责鉴权的核心，除了微信的openId那一套，其余的都需要自己实现。

也就是说，所谓的用户表和注册登录验证的流程都需要具体设计。

### 自定义登录的流程

先说一下这个授权的过程，也是后面流程设计的依据。

![流程图](liuchengtu.png)

上图取自官方文档，可见是先验证登录，成功后返回由用户UID生成的ticket，再凭此对云开发资源进行访问。

这样就造成了一个问题，如果用户系统也构建在云开发上，那么登录之前怎么读写数据库呢？

### 未登录状态的交互

#### 匿名登录

官方提供了一个`匿名登录`的方法，不需要服务端操作，设置好对应资源的访问权限即可。

匿名登录后，这个用户状态会一直留在设备上，不会过期。也有接口将其转化为新的自定义登录用户，相当于新建一个UID，然后连接到生成的ticket上，之前的私有数据都会保留。

这种方法的缺陷在于：

1. 规定每个环境最多生成1000个匿名用户。
2. 匿名登录状态虽然可以保存私有数据，但是并不稳定。如果卸载后重装App，会生成新的匿名用户。

此外，据测试在后台的用户管理中也看不到匿名用户的信息，所以管理起来还是有点麻烦。

#### 借助云函数实现


